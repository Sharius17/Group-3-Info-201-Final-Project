---
title: "Final Project"
author: "Joy Li, Cam Bun, Marisa Johnson, Shana Arius"
date: "2023-11-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidycensus)
options(scipen = 999)
```

Obtaining census datasets, preliminary dataset joining and cleaning
```{r, eval = F}
# codebook for survey variables
keys <- load_variables(2022, "acs1/subject", cache = T) %>% filter(str_detect(name, "S0802"))

# first extract earliest (2010) data to initialize data frames
# later years will be appended to this
s0802_WA <- get_acs(geography = "state",
        table = "S0802",
        state = "WA",
        gemoetry = TRUE,
        survey = "acs1",
        year = 2010,
        cache_table = T) %>% 
  select(NAME, variable, estimate) %>% 
  mutate(year = 2010) %>% 
  rename("location" = NAME)

s0802_sea <- get_acs(geography = "place",
        table = "S0802",
        state = "WA",
        gemoetry = TRUE,
        survey = "acs1",
        year = 2010,
        cache_table = T) %>% 
  filter(NAME == "Seattle city, Washington") %>% 
  select(NAME, variable, estimate) %>% 
  mutate(year = 2010) %>% 
  rename("location" = NAME)

# appending years 2011-2022 
nums <- 2011:2022
# need to omit the year 2020 because the regular 1-year ACS for 2020 was not released and is not available in tidycensus.
nums <- nums[nums != 2020]

for (i in nums) {
  temp_WA <- get_acs(geography = "state",
        table = "S0802",
        state = "WA",
        gemoetry = TRUE,
        survey = "acs1",
        year = i,
        cache_table = T) %>% 
  select(NAME, variable, estimate) %>% 
  mutate(year = i) %>% 
  rename("location" = NAME)
  s0802_WA <- rbind(s0802_WA, temp_WA)
  
  temp_sea <- get_acs(geography = "place",
        table = "S0802",
        state = "WA",
        gemoetry = TRUE,
        survey = "acs1",
        year = i,
        cache_table = T) %>% 
  filter(NAME == "Seattle city, Washington") %>% 
  select(NAME, variable, estimate) %>% 
  mutate(year = i) %>% 
  rename("location" = NAME)
  s0802_sea <- rbind(s0802_sea, temp_sea)
}

# export these datasets for safekeeping
write.csv(s0802_WA, "Data/Clean/s0802_WA.csv", row.names = F)
write.csv(s0802_sea, "Data/Clean/s0802_sea.csv", row.names = F)
write.csv(keys, "Data/Clean/s0802_keys.csv", row.names = F)
```

Load datasets for next stage of cleaning
```{r, eval = F}
s0802_WA <- read_delim("Data/Clean/s0802_WA.csv")
s0802_sea <- read_delim("Data/Clean/s0802_sea.csv")
s0802_keys <- read_delim("Data/Clean/s0802_keys.csv")

crash_sea <- read_delim("Data/Clean/seattle_collisions.csv")
crash_WA <- read_delim("Data/Clean/wa_collisions.csv")

gas_sea <- read_delim("Data/Clean/seattle_gas_dollars_per_gallon.csv")
gas_WA <- read_delim("Data/Clean/wa_gas_dollars_per_gallon.csv")
```

Combine data
```{r, eval = F}
# rename column so that it can be joined to s0802 table
# also separate out variable labels into multiple columns
s0802_keys <- s0802_keys %>% 
  select(name, label) %>% 
  rename("variable" = name) %>% 
  separate_wider_delim(cols = label, 
                       delim = "!!", 
                       names = c("trait1", "trait2", "trait3", "trait4", "trait5", "trait6"),
                       too_few = "align_start")

  
# combine Seattle and WA data, join keys
s0802 <- rbind(s0802_sea, s0802_WA) %>% left_join(s0802_keys)

# add location variable to gas data so it can be joined
gas_sea <- gas_sea %>% mutate(location = "Seattle city, Washington")
gas_WA <- gas_WA %>% mutate(location = "Washington")

gas <- rbind(gas_WA, gas_sea)

# tidy collision data from wide to long form
# need to be yearly, not monthly, tally up each column
crash_sea_yearly <- crash_sea %>% 
  pivot_longer(2:18, names_to = "year", values_to = "crashes") %>%
  group_by(year) %>% 
  summarize(total_crashes = sum(crashes)) %>% 
  mutate(location = "Seattle city, Washington", year = as.numeric(year))

crash_WA_yearly <- crash_WA %>% 
  pivot_longer(2:18, names_to = "year", values_to = "crashes") %>%
  group_by(year) %>% 
  summarize(total_crashes = sum(crashes)) %>% 
  mutate(location = "Washington", year = as.numeric(year))

# joining datasets
gas_and_crashes <- rbind(crash_WA_yearly, crash_sea_yearly) %>% 
  left_join(gas) %>% 
  rename("gas_price" = price)

# save these tidy updated datasets
write.csv(s0802, "Data/Clean/s0802.csv", row.names = F)
write.csv(gas_and_crashes, "Data/Clean/gas_and_crashes.csv", row.names = F)
```
Load tidy datasets
```{r}
s0802 <- read_delim("Data/Clean/s0802.csv")
gas_and_crashes <- read_delim("Data/Clean/gas_and_crashes.csv")
```

Final joining
```{r}
final <- left_join(s0802, gas_and_crashes, by = c("year", "location"))
```

How does means of transportation vary with earnings?
```{r}
final %>% filter(trait4 == "Workers 16 years and over with earnings", 
                 location == "Seattle city, Washington") %>% 
  group_by(trait5, trait2) %>%
  filter(trait5 != c("Median earnings (dollars)", NA), trait2 != "Total") %>% 
  summarize(estimate = mean(estimate)) %>% 
  ggplot(aes(x = trait5, y = estimate, fill = trait2)) +
  geom_col(position = "fill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Proportions of Transportation Types by Income in Seattle",
       x = "Income",
       y = "Proportion (%)",
       fill = "Means of Transportation")
```

How has means of transportation changed over time in Seattle?
```{r}
final %>% filter(location == "Seattle city, Washington", 
                 trait2 != "Total", 
                 str_ends(variable, "001")) %>% 
  ggplot(aes(x = year, y = estimate, fill = trait2)) +
  geom_col(position = "fill")
```

color = year
x = median earnings
y = gas
```{r}
final %>% filter(str_ends(variable, "037"),
                 location == "Seattle city, Washington") %>% 
  group_by(year, gas_price) %>% 
  summarise(estimate = mean(estimate)) %>% 
  ggplot(aes(estimate, gas_price)) +
  geom_point(aes(color = factor(year))) +
  geom_path() +
  labs(x = "Median Salary ($)")
```

